modules:
  - type: containerfile
    snippets:
      # Copy pre-built NVIDIA Open kernel modules from ublue-os
      - COPY --from=ghcr.io/ublue-os/akmods-nvidia-open:main-43 /rpms/ /tmp/rpms
      - RUN find /tmp/rpms
      # Install ublue NVIDIA configuration package (sets up repos) using dnf5
      - RUN dnf5 install -y /tmp/rpms/ublue-os/ublue-os-nvidia*.rpm
      # Enable negativo17 nvidia repo (dnf5 config-manager approach like Bluefin)
      - RUN dnf5 config-manager setopt fedora-nvidia.enabled=1
      # Install kernel modules and userspace drivers using dnf5
      # NOTE: nvidia-container-toolkit excluded on F43 (crypto digest issue)
      - RUN dnf5 install -y /tmp/rpms/kmods/kmod-nvidia*.rpm libnvidia-fbc libva-nvidia-driver nvidia-driver nvidia-driver-cuda nvidia-modprobe nvidia-persistenced
      # Disable repos after install (security)
      - RUN dnf5 config-manager setopt fedora-nvidia.enabled=0

  - type: script
    scripts:
      - nvidia-post-install.sh

  - type: systemd
    system:
      enabled:
        - nvidia-persistenced.service
